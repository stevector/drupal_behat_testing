# Job Definition Template for the DrupalCI 'Behat' Job Type
environment:
  db:
    - %DCI_DBVersion%
  web:
    - %DCI_PHPVersion%
setup:
  checkout:
    # DCI_UseLocalCodebase plugin can override the checkout array to look like:
    # - protocol: local
    #   source_dir: %DCI_SourceDirectory%
    - protocol: git
      repo: %DCI_CoreRepository%
      branch: %DCI_CoreBranch%
      depth: %DCI_GitCheckoutDepth%
      checkout_dir: .
      commit_hash: %DCI_GitCommitHash%
  # Create the directory where we will store our results
  mkdir:
    - /var/www/html/results
    - /var/www/html/artifacts
    - /var/www/html/sites/simpletest/xml
  command:
    - ln -s /var/www/html /var/www/html/checkout
    - chown -fR www-data:www-data /var/www/html/sites /var/www/html/results
    - chmod 0777 /var/www/html/artifacts
    - chmod 0777 /tmp
  syntaxcheck: true
# The 'install' key is currently required for the dbcreate plugin
# TODO: make dbcreate consistent with other commands and place in pre-install
install:
execute:
  command:
    # - cd / composer update
    - cd /var/www/html/checkout && /.composer/vendor/drush/drush/drush site-install  --db-url=%DCI_DBUrl% --uri=http://localhost/checkout    -y
    # @todo this change seems hacky. There's probably a better way to ensure
    # test themes are available.
    # taken from https://github.com/stevector/template_mapper/blob/8.x-1.x/.travis.yml
    - chmod 777 /var/www/html/checkout/sites/default
    - chmod 777 /var/www/html/checkout/sites/default/settings.php
    - sed -i '$ a\ $settings['extension_discovery_scan_tests'] = TRUE;' /var/www/html/checkout/sites/default/settings.php
    - %DCI_RunScriptBehat%

publish:
# @todo I don't understand how the artifacts part works.
#  gather_artifacts: /var/www/html/artifacts
